2021/12/15
- CX+ アクセス出来ない、ページのロードが遅い

- 原因
    - Elasticsearch サーバーが CX+ からのリクエストを処理しきれず、レスポンスが遅くなってしまった
        - コストのかかるリクエストに時間がかかり、
        - その間にも様々なリクエストが送られ、Elasticsearch サーバーに対する負荷が雪だるま式に増大していった
    - Elasticsearch のサーバーがリクエストのスパイクに応じてスケールできる作りになっていなかった
        - 基本的に EC2 インスタンス 1個で稼働で、負荷分散など出来ていなかった
        - Elasticsearch の仕様により、AutoScaling グループを使って EC2 インスタンスを同一ネットワークに複数稼働させることが困難だった
            - Elasticsearch をきちんと理解していないと、複数サーバーで稼働するのが難しい感じ・・・

- 対応
    - Amazon Opensearch Service を使う
        - スケール可能
            - コンソール画面で簡単に設定変更できる
                - インスタンスタイプ
                - ノード数
                - EBSボリュームのサイズ
        - Elasticsearchサーバー群を運用するための複雑な知識が不要

- Opensearch サーバーへの切り替えまでの計画
    - Opensearch のサーバーを建てる
    - 旧 Elasticsearch サーバーから Opensearch へデータをコピーする
    - Opensearch にバージョンアップしたことで、APIの仕様が変わっているので、CX+のプログラムを修正

- ハマったポイント
    - Elasticsearch を理解すること
        - 用語がややこしい
            - インデックス → RDB のインデックスとは似て非なるもの
        - ただ、動作確認するためにデータを保存・検索するのも一苦労
            - RDBMS とはまったく異なる
            - v1.3 と 現在のバージョン v8 では大きく API の内容がことなる
                - `elasticsearch データ保存` や、 `elasticsearch 検索` でググると、 v8 の内容が出てくるので、v1.3 では全く使えない
    - 環境構築
        - 完全に AWS とかネットワークに関する知識不足が原因
        - docker ダウンロード出来ない
            - インターネットゲートウェイが設定されたパブリックなサブネットだけど、EC2 インスタンス自体にパブリックIP(Elastic IP)が割り当てられていないと、インターネットと通信が出来ない
        - 0.0.0.0/0 とすべきところを、0.0.0.0/32 にしてしまったり
        - EC2、ALB(NLB)、Opensearch それぞれにセキュリティグループの設定が必要
        - ルートテーブルで、vpc 内の ip アドレスに向けた通信を local にルーティングするレコードがあれば、通信可能(サブネットが異なっても、vpc の cidr の範囲は恩智だから通信できる)
    - 現行サーバーから新サーバーへのデータ移行
        - スナップショットによるデータコピー
            - ES → S3 → OS
            - elasticsearch v1.3 で吐き出したスナップショットが、 elasticsearch v7 と互換性がなくまったくデータの移行が出来ない
        - reindex API
            - ES → OS
            - スナップショットによる方法より Opensearch に移行できるデータが増えたが、Opensearch に互換性の無いデータでエラーが発生し、それ以降のデータ移行ができなくなる
                - 1000 件バッチで実行、1件目でエラー、残りの999件で実行されず・・・結果全くデータ以降出来ないという結果に
        - elasticdump
            - reindex を実行しているっぽい
            - nginx 経由で OS にデータを送る場合、max body size のエラー
            - nginx を適切に設定したり、nginx 経由せず直接 ES → OS にデータを送る用にしたら、解消